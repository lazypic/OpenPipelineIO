{{define "directupload" }}
{{template "headBootstrap5"}}
<body data-bs-theme="dark">
{{template "navbar-bootstrap5" .}}

<div class="container pt-3">
        <div class="pt-1 pb-3">
            <h2 class="text-muted">Direct Upload</h2>
        </div>
	<div id="dropZone" class="text-muted border border-warning p-5 text-center">
		Please drag and drop your file(s) here.
	</div>
	<div class="pt-2 text-center">
        <button id="fileSelectBtn" class="btn btn-primary">파일 선택</button>
        <button id="folderSelectBtn" class="btn btn-warning">폴더 선택</button>
    </div>
    <input type="file" id="fileInputFiles" multiple class="form-control d-none">
    <input type="file" id="fileInputFolder" multiple webkitdirectory directory class="form-control d-none">
</div>

<div class="container pt-2">
        <div class="pt-3 pb-1">
            <h5 class="text-muted">Process list</h5>
        </div>
	<div class="row g-2">
		<div class="col col-12 col-sm-12 col-md-6 col-lg-6 col-xl-6">
			<div id="scheduleList" class="list-group"></div>
		</div>
		<div class="col col-12 col-sm-12 col-md-6 col-lg-6 col-xl-6">
			<div id="fileList" class="list-group"></div>
		</div>
	</div>
</div>

</div>
<div class="container pt-2">
</div>

{{template "footerBootstrap" .}}
</body>
<script src="/assets/bootstrap-5.0.2/js/bootstrap.min.js"></script>

<script src="/assets/bootstrap-5.0.2/js/bootstrap.min.js"></script>

<script>
const dropZone = document.getElementById("dropZone");
const fileInputFiles = document.getElementById("fileInputFiles");
const fileInputFolder = document.getElementById("fileInputFolder");
const fileSelectBtn = document.getElementById("fileSelectBtn");
const folderSelectBtn = document.getElementById("folderSelectBtn");
const fileList = document.getElementById("fileList");
const scheduleList = document.getElementById("scheduleList");

const socket = new WebSocket('/ws/directuploadprogress');

socket.onopen = () => console.log("WebSocket 연결 성공");
socket.onerror = (error) => console.error("WebSocket 오류:", error);
socket.onclose = () => console.log("WebSocket 연결 종료");

// 파일 선택 버튼 클릭 시
fileSelectBtn.addEventListener("click", () => fileInputFiles.click());
folderSelectBtn.addEventListener("click", () => fileInputFolder.click());

// 파일 선택 시 이벤트 핸들링
fileInputFiles.addEventListener("change", (e) => handleFiles(e.target.files));
fileInputFolder.addEventListener("change", (e) => handleFiles(e.target.files, true));

// 드래그 앤 드롭 이벤트
dropZone.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropZone.style.background = "#383838";
});

dropZone.addEventListener("dragleave", () => {
    dropZone.style.background = "#141414";
});

dropZone.addEventListener("drop", async (e) => {
    e.preventDefault();
    dropZone.style.background = "#141414";
    handleFiles(e.dataTransfer.files, true);
});

// 파일 업로드 처리
function handleFiles(files, isFolder = false) {
    const formData = new FormData();
    for (const file of files) {
        formData.append("files", file);
        formData.append("relativePath[]", isFolder ? file.webkitRelativePath : file.name);
        addScheduleList(isFolder ? file.webkitRelativePath : file.name);
    }

    fetch("/ws/directupload", { method: "POST", body: formData })
        .then(response => response.json())
        .then(data => console.log("업로드 완료:", data));
}

// 업로드 스케줄 목록 추가
function addScheduleList(fileName) {
    const li = document.createElement("div");
    li.id = "schedule_" + fileName;
    li.classList.add("list-group-item", "text-secondary", "bg-dark", "mt-1");
    li.textContent = "[Scheduled] " + fileName;

    const progressDiv = document.createElement("div");
    progressDiv.classList.add("progress");
    progressDiv.style.height = "1px";

    const progressBarDiv = document.createElement("div");
    progressBarDiv.classList.add("progress-bar", "bg-success");
    progressBarDiv.style.width = "0%";

    progressDiv.appendChild(progressBarDiv);
    li.appendChild(progressDiv);
    scheduleList.appendChild(li);
}

// WebSocket을 이용한 업로드 진행 상태 업데이트
socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    let item = document.getElementById(data.fileName);

    if (!item) {
        item = document.createElement("div");
        item.className = "list-group-item text-light bg-dark mt-1";
        item.id = data.fileName;
        item.textContent = `${data.fileName} - 0%`;

        const progressDiv = document.createElement("div");
        progressDiv.classList.add("progress");
        progressDiv.style.height = "1px";

        const progressBarDiv = document.createElement("div");
        progressBarDiv.classList.add("progress-bar", "bg-success");
        progressBarDiv.style.width = "0%";

        progressDiv.appendChild(progressBarDiv);
        item.appendChild(progressDiv);
        fileList.appendChild(item);
    }

    item.textContent = `${data.fileName} - ${data.progress}%`;
    const progressBar = item.querySelector(".progress-bar");
    if (progressBar) {
        progressBar.style.width = data.progress + "%";
        progressBar.setAttribute("aria-valuenow", data.progress);
    }
};
</script>

</html>
{{end}}
