{{define "directupload" }}
{{template "headBootstrap5"}}
<body data-bs-theme="dark">
{{template "navbar-bootstrap5" .}}

<div class="container py-5 px-2">
    <div class="col-lg-12 col-md-12 col-sm-12 mx-auto">
        <div class="pt-1 pb-3">
            <h2 class="text-muted">Direct upload</h2>
        </div>
	<div id="dropZone" class="text-muted">여기에 파일을 드래그하세요</div>

	<input type="file" id="fileInput" multiple webkitdirectory directory class="form-control d-none">

	<ul id="fileList" class="list-group bg-dark text-light"></ul>
    </div>

</div>

{{template "footerBootstrap" .}}
</body>
<script src="/assets/bootstrap-5.0.2/js/bootstrap.min.js"></script>

<script>
	const dropZone = document.getElementById("dropZone");
        const fileInput = document.getElementById("fileInput");
        const fileList = document.getElementById("fileList");

	// input 클릭 시 파일 선택
        fileInput.addEventListener("change", (e) => {
            handleFiles(e.target.files);
        });

        // 드래그앤드롭존 클릭하면 input 실행
        dropZone.addEventListener("click", () => {
            fileInput.click();
        });

        // 드래그앤드롭 처리
        dropZone.addEventListener("dragover", (e) => {
            e.preventDefault();
            dropZone.style.background = "#666666";
        });

        dropZone.addEventListener("dragleave", () => {
            dropZone.style.background = "#333333";
        });

        dropZone.addEventListener("drop", (e) => {
            e.preventDefault();
            dropZone.style.background = "#333333";
            handleFiles(e.dataTransfer.files);
        });

	document.getElementById("dropZone").addEventListener("drop", async (e) => {
		e.preventDefault();
		e.stopPropagation(); // 기본 이벤트 방지
		const items = e.dataTransfer.items;
		const formData = new FormData();

		async function traverseFileTree(item, path = "") {
			return new Promise((resolve) => {
				if (item.isFile) {
					item.file((file) => {
						formData.append("files", file);
						formData.append("relativePath[]", path + file.name);
						addFileToList(path + file.name);
						resolve();
					});
				} else if (item.isDirectory) {
					const dirReader = item.createReader();
					dirReader.readEntries(async (entries) => {
						for (const entry of entries) {
							await traverseFileTree(entry, path + item.name + "/");
						}
						resolve();
					});
				}
			});
		}

		const promises = [];
		for (const item of items) {
			const entry = item.webkitGetAsEntry();
			if (entry) promises.push(traverseFileTree(entry));
		}

		await Promise.all(promises);

		fetch("/ws/directupload", { method: "POST", body: formData })
		.then(response => response.json())
		.then(data => {
			alert("업로드 완료");
			console.log(data);
		});
	});

	function addFileToList(fileName) {
		const li = document.createElement("li");
		li.classList.add("list-group-item");
		li.classList.add("text-light");
		li.classList.add("bg-dark");
		li.textContent = fileName;
		document.getElementById("fileList").appendChild(li);
	}
</script>

</html>
{{end}}
